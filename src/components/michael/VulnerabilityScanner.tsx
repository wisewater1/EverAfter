import { useState, useEffect } from 'react';
import { Search, AlertTriangle, CheckCircle, Shield, Clock } from 'lucide-react';
import { getLiveVulnerabilities, VulnerabilityEntry, ThreatSeverity, triggerLiveScan } from '../../lib/michael/security';

const SEVERITY_DOT: Record<ThreatSeverity, string> = {
    critical: 'bg-rose-500', high: 'bg-orange-500', medium: 'bg-amber-500', low: 'bg-sky-500',
};

const STATUS_STYLES: Record<string, { bg: string; text: string }> = {
    open: { bg: 'bg-rose-500/10 border-rose-500/20', text: 'text-rose-400' },
    patched: { bg: 'bg-emerald-500/10 border-emerald-500/20', text: 'text-emerald-400' },
    mitigated: { bg: 'bg-sky-500/10 border-sky-500/20', text: 'text-sky-400' },
    accepted: { bg: 'bg-slate-500/10 border-slate-500/20', text: 'text-slate-400' },
};

export default function VulnerabilityScanner() {
    const [vulns, setVulns] = useState<VulnerabilityEntry[]>([]);
    const [search, setSearch] = useState('');
    const [scanning, setScanning] = useState(false);
    const [lastScan, setLastScan] = useState<string | null>(null);

    const loadVulns = async () => {
        const data = await getLiveVulnerabilities();
        setVulns(data);
    };

    useEffect(() => {
        loadVulns();
    }, []);

    const filtered = vulns.filter(v =>
        v.title.toLowerCase().includes(search.toLowerCase()) ||
        v.cveId.toLowerCase().includes(search.toLowerCase()) ||
        v.affectedComponent.toLowerCase().includes(search.toLowerCase())
    );

    const handleScan = async () => {
        setScanning(true);
        try {
            await triggerLiveScan();
            await loadVulns();
            setLastScan(new Date().toLocaleTimeString());
        } catch (e) {
            console.error("Scan failed", e);
        } finally {
            setScanning(false);
        }
    };

    const openCount = vulns.filter(v => v.status === 'open').length;
    const critCount = vulns.filter(v => v.severity === 'critical').length;

    return (
        <div className="space-y-6">
            {/* Stats + Scan */}
            <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
                <div className="flex items-center gap-6">
                    <div className="text-center">
                        <div className="text-3xl font-light text-white">{vulns.length}</div>
                        <div className="text-[10px] text-slate-500 uppercase font-bold">Total CVEs</div>
                    </div>
                    <div className="w-px h-10 bg-white/5" />
                    <div className="text-center">
                        <div className={`text-3xl font-light ${openCount > 0 ? 'text-rose-400' : 'text-emerald-400'}`}>{openCount}</div>
                        <div className="text-[10px] text-slate-500 uppercase font-bold">Open</div>
                    </div>
                    <div className="w-px h-10 bg-white/5" />
                    <div className="text-center">
                        <div className={`text-3xl font-light ${critCount > 0 ? 'text-rose-400' : 'text-white'}`}>{critCount}</div>
                        <div className="text-[10px] text-slate-500 uppercase font-bold">Critical</div>
                    </div>
                </div>
                <div className="flex flex-col items-end gap-1">
                    <button onClick={handleScan} disabled={scanning}
                        className={`px-5 py-2.5 bg-sky-600 hover:bg-sky-500 disabled:bg-slate-800 text-white rounded-xl text-sm font-medium transition-all flex items-center gap-2 ${scanning ? 'animate-pulse' : ''}`}>
                        {scanning ? <Shield className="w-4 h-4 animate-spin" /> : <Search className="w-4 h-4" />}
                        {scanning ? 'Auditing Records...' : 'Run CVE & Akashic Scan'}
                    </button>
                    {lastScan && (
                        <div className="flex items-center gap-1 text-[10px] text-slate-500 italic">
                            <Clock className="w-3 h-3" />
                            Last full audit: {lastScan}
                        </div>
                    )}
                </div>
            </div>

            {/* Search */}
            <div className="relative">
                <Search className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-500" />
                <input type="text" value={search} onChange={e => setSearch(e.target.value)}
                    placeholder="Search CVEs, titles, components..."
                    className="w-full pl-10 pr-4 py-2.5 bg-slate-800/60 border border-white/10 rounded-xl text-sm text-white placeholder:text-slate-500 focus:outline-none focus:border-sky-500/50 transition-all" />
            </div>

            {/* CVE Table */}
            <div className="bg-slate-900/40 border border-white/5 rounded-3xl overflow-hidden">
                <div className="overflow-x-auto">
                    <table className="w-full text-sm">
                        <thead>
                            <tr className="border-b border-white/5">
                                <th className="text-left text-[10px] text-slate-500 uppercase tracking-widest p-4 font-bold">CVE ID</th>
                                <th className="text-left text-[10px] text-slate-500 uppercase tracking-widest p-4 font-bold">Title</th>
                                <th className="text-left text-[10px] text-slate-500 uppercase tracking-widest p-4 font-bold">Severity</th>
                                <th className="text-left text-[10px] text-slate-500 uppercase tracking-widest p-4 font-bold">CVSS</th>
                                <th className="text-left text-[10px] text-slate-500 uppercase tracking-widest p-4 font-bold">Component</th>
                                <th className="text-left text-[10px] text-slate-500 uppercase tracking-widest p-4 font-bold">Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {filtered.map(v => {
                                const ss = STATUS_STYLES[v.status];
                                return (
                                    <tr key={v.id} className="border-b border-white/5 hover:bg-white/[0.02] transition-colors group">
                                        <td className="p-4 font-mono text-sky-400 text-xs">{v.cveId}</td>
                                        <td className="p-4">
                                            <div className="text-white font-medium">{v.title}</div>
                                            <div className="text-xs text-slate-500 mt-0.5">{v.description}</div>
                                        </td>
                                        <td className="p-4">
                                            <span className="flex items-center gap-2">
                                                <span className={`w-2 h-2 rounded-full ${SEVERITY_DOT[v.severity]}`} />
                                                <span className="text-xs text-slate-300 uppercase font-bold">{v.severity}</span>
                                            </span>
                                        </td>
                                        <td className="p-4">
                                            <span className={`text-sm font-medium ${v.cvssScore >= 9 ? 'text-rose-400' : v.cvssScore >= 7 ? 'text-orange-400' : v.cvssScore >= 4 ? 'text-amber-400' : 'text-sky-400'}`}>
                                                {v.cvssScore.toFixed(1)}
                                            </span>
                                        </td>
                                        <td className="p-4 text-xs text-slate-400">{v.affectedComponent}</td>
                                        <td className="p-4">
                                            <span className={`inline-flex items-center gap-1 px-2 py-1 rounded text-[10px] font-bold uppercase border ${ss.bg} ${ss.text}`}>
                                                {v.status === 'patched' && <CheckCircle className="w-3 h-3" />}
                                                {v.status === 'open' && <AlertTriangle className="w-3 h-3" />}
                                                {v.status}
                                            </span>
                                        </td>
                                    </tr>
                                );
                            })}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    );
}
